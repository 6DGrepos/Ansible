---
- name: Collect currently running servers and services
  hosts: all
  tasks:
    - name: Gather facts
      ansible.builtin.setup:
        gather_subset: all

    - name: Create directory on remote server
      ansible.builtin.file:
        path: "/home/svc_aux/backup/files/{{ ansible_hostname }}"
        state: directory
      delegate_to: 10.1.34.26

    - name: Clear previous data before reboot
      ansible.builtin.file:
        path: "/home/svc_aux/backup/files/{{ ansible_hostname }}/running_services_before_reboot.txt"
        state: absent
      delegate_to: 10.1.34.26

    - name: Collect running services
      ansible.builtin.shell: systemctl list-units --type=service --state=running
      register: running_services

    - name: Save running services to a file on remote server
      ansible.builtin.copy:
        content: "{{ running_services.stdout }}"
        dest: "/home/svc_aux/backup/files/{{ ansible_hostname }}/running_services_before_reboot.txt"
      delegate_to: 10.1.34.26
