---
- name: Check for available updates on Debian and RedHat systems
  hosts: all
  become: yes
  tasks:
    - name: Gather facts about the system
      ansible.builtin.gather_facts:

    - name: Get the hostname of the system
      shell: uname -n
      register: system_hostname

    - name: Check for available updates on Debian-based systems
      shell: apt list --upgradable
      when: ansible_facts['os_family'] == 'Debian'
      register: debian_updates
      ignore_errors: yes

    - name: Check for available updates on RedHat-based systems (using dnf)
      shell: dnf list updates
      when: 
        - ansible_facts['os_family'] == 'RedHat'
        - ansible_distribution != 'Rocky'
      register: redhat_updates
      ignore_errors: yes

    - name: Check for available updates on Rocky Linux (using yum)
      shell: yum check-update
      when: ansible_distribution == 'Rocky'
      register: rocky_updates
      ignore_errors: yes
      failed_when: rocky_updates.rc not in [0, 100]

    - name: Ensure patchlist file exists and clear old contents on 10.1.34.26
      ansible.builtin.file:
        path: /home/svc_aux/backup/patchinformation/patchlist.txt
        state: touch
      delegate_to: 10.1.34.26

    - name: Clear old contents of patchlist file on 10.1.34.26
      ansible.builtin.copy:
        dest: /home/svc_aux/backup/patchinformation/patchlist.txt
        content: ""
      delegate_to: 10.1.34.26

    - name: Format and write updates to patchlist file on 10.1.34.26 (Debian)
      ansible.builtin.lineinfile:
        path: /home/svc_aux/backup/patchinformation/patchlist.txt
        line: |
          -----------------------------------
          hostname: {{ system_hostname.stdout }}
          {{ debian_updates.stdout | replace('\n', '\n') }}
          -----------------------------
      when: ansible_facts['os_family'] == 'Debian'
      delegate_to: 10.1.34.26

    - name: Format and write updates to patchlist file on 10.1.34.26 (RedHat)
      ansible.builtin.lineinfile:
        path: /home/svc_aux/backup/patchinformation/patchlist.txt
        line: |
          -----------------------------------
          hostname: {{ system_hostname.stdout }}
          {{ redhat_updates.stdout | default('') | replace('\n', '\n') }}
          {{ rocky_updates.stdout | default('') | replace('\n', '\n') }}
          -----------------------------
      when: ansible_facts['os_family'] == 'RedHat'
      delegate_to: 10.1.34.26
