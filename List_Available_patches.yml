---
- name: Linux Patching Playbook
  hosts: all
  become: yes
  vars:
    output_server: "10.1.34.26"
    output_file: "/home/svc_aux/backup/patchinformation/patchlist.txt"

  tasks:
    - name: Ensure output directory exists on output server
      file:
        path: "/home/svc_aux/backup/patchinformation"
        state: directory
      delegate_to: "{{ output_server }}"
      run_once: true

    - name: Clear previous content of the output file
      file:
        path: "{{ output_file }}"
        state: absent
      delegate_to: "{{ output_server }}"
      run_once: true

    - name: Create empty output file
      file:
        path: "{{ output_file }}"
        state: touch
      delegate_to: "{{ output_server }}"
      run_once: true

    - name: Get hostname
      command: uname -n
      register: hostname
      changed_when: false

    - name: Update apt cache (Debian)
      apt:
        update_cache: yes
      when: ansible_os_family == "Debian"

    - name: List available updates (Debian)
      shell: apt list --upgradable 2>/dev/null | grep -v "Listing..." || echo "No updates available"
      register: debian_updates
      changed_when: false
      when: ansible_os_family == "Debian"

    - name: List available updates (RedHat)
      shell: dnf check-update -q || echo "No updates available"
      register: redhat_updates
      changed_when: false
      when: ansible_os_family == "RedHat"

    - name: Generate patch list content
      set_fact:
        patch_content: >
          {% if ansible_os_family == "Debian" %}
          {% if debian_updates.stdout_lines | length > 0 and debian_updates.stdout != "No updates available" %}
          {{ debian_updates.stdout }}
          {% else %}
          No updates available
          {% endif %}
          {% elif ansible_os_family == "RedHat" %}
          {% if redhat_updates.stdout_lines | length > 0 and redhat_updates.stdout != "No updates available" %}
          {{ redhat_updates.stdout }}
          {% else %}
          No updates available
          {% endif %}
          {% endif %}

    - name: Write patch list to file on output server
      copy:
        content: "{{ hostname.stdout }}\n\n{{ patch_content }}\n"
        dest: "{{ output_file }}"
      delegate_to: "{{ output_server }}"
