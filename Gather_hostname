---
- name: Gather hostname, IP address, and OS version
  hosts: all
  gather_facts: yes
  tasks:
    - name: Gather host information
      setup:
        gather_subset:
          - 'hardware'
          - 'network'
          - 'virtual'
          - 'facter'
          - 'ohai'
          - '!all'
          - '!min'
    
    - name: Collect host information
      set_fact:
        host_info: |
          {{ ansible_hostname }},{{ ansible_default_ipv4.address }},{{ ansible_distribution }} {{ ansible_distribution_version }}

    - name: Write host information to CSV file
      local_action:
        module: lineinfile
        path: ./host_info.csv
        line: "{{ host_info }}"
        create: yes
      delegate_to: localhost
      run_once: true

    - name: Append host information to CSV file
      local_action:
        module: lineinfile
        path: ./host_info.csv
        line: "{{ host_info }}"
        create: yes
      delegate_to: localhost
      run_once: false
